# pdf_reader.py ‚Äî ULYULYU CHECKER
# –í–µ—Ä—Å–∏—è: v2.2 (Pattern Reference Integrated Edition)
# –ê–≤—Ç–æ—Ä: frukt22
# –î–∞—Ç–∞: 2025-11-09
# ------------------------------------------------------------
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ë–ò–ù–æ–≤, –¥–∞—Ç—ã –∏ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã –∏–∑ PDF-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–≠–°–§, —Å—á—ë—Ç, –°–ù–¢)
#   –£—Å—Ç–æ–π—á–∏–≤–æ –∫ –ª—é–±—ã–º —Ñ–æ—Ä–º–∞—Ç–∞–º: egov.kz, 1–°, SAP, iDocs, OCR.
# ------------------------------------------------------------
# –û–±–Ω–æ–≤–ª–µ–Ω–∏—è:
#   ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ pdf_patterns_reference.md
#   ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ "–ë–ò–ù", "–î–∞—Ç–∞", "–í—Å–µ–≥–æ —Å –ù–î–°"
#   ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ —á–∏—Å–µ–ª
# ------------------------------------------------------------

import re
import os
import unicodedata
from typing import Dict, Any
from PyPDF2 import PdfReader


# ------------------------------------------------------------
# üß© –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
# ------------------------------------------------------------
def parse_pdf_content(file_path: str) -> Dict[str, Any]:
    if not os.path.exists(file_path):
        raise FileNotFoundError(f"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")

    reader = PdfReader(file_path)
    text = ""
    for page in reader.pages:
        try:
            text += page.extract_text() + "\n"
        except Exception:
            continue

    # ------------------------------------------------------------
    # üßπ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
    # ------------------------------------------------------------
    text = unicodedata.normalize("NFKC", text)
    text = text.replace("\u00A0", " ")  # –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª
    text = text.replace("‚Ä¢", ".").replace("\uf0b7", ".")  # bullet
    text = re.sub(r"[ \t]+", " ", text)
    text = re.sub(r"\s{2,}", " ", text)
    text = re.sub(r"\n+", "\n", text).strip()

    # ------------------------------------------------------------
    # üîç –ë–ò–ù ‚Äî –ø–æ—Å—Ç–∞–≤—â–∏–∫ –∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å
    # ------------------------------------------------------------
    supplier_bin = ""
    buyer_bin = ""

    BIN_SUP_PATTERNS = [
        r"–ë–ò–ù[^\n]{0,10}–ø–æ—Å—Ç–∞–≤—â–∏–∫[^\d]{0,10}([0-9]{11,12})",
        r"–ë–ò–ù[^\n]{0,5}\(?–ø–æ—Å—Ç–∞–≤—â–∏–∫–∞\)?[^\d]{0,10}([0-9]{11,12})",
        r"–ë–ò–ù–ü–æ—Å—Ç–∞–≤—â–∏–∫[^\d]{0,10}([0-9]{11,12})",
        r"–ë–ò–ù[^0-9]{0,5}[‚Ññ:‚Äì-]?\s*([0-9]{11,12})",  # –ë–ò–ù ‚Ññ ...
        r"–ò–ù–ù\s*/\s*–ë–ò–ù[:\s]*([0-9]{11,12})",
        r"–†–ù–ù/–ë–ò–ù[^\d]{0,10}([0-9]{11,12})",
    ]
    BIN_BUY_PATTERNS = [
        r"–ë–ò–ù[^\n]{0,10}–ø–æ–∫—É–ø–∞—Ç–µ–ª[^\d]{0,10}([0-9]{11,12})",
        r"–ë–ò–ù[^\n]{0,5}\(?–ø–æ–∫—É–ø–∞—Ç–µ–ª—è\)?[^\d]{0,10}([0-9]{11,12})",
        r"–ë–ò–ù–ü–æ–∫—É–ø–∞—Ç–µ–ª[^\d]{0,10}([0-9]{11,12})",
    ]

    for pat in BIN_SUP_PATTERNS:
        m = re.search(pat, text, re.IGNORECASE)
        if m:
            supplier_bin = m.group(1)
            break

    for pat in BIN_BUY_PATTERNS:
        m = re.search(pat, text, re.IGNORECASE)
        if m:
            buyer_bin = m.group(1)
            break

    if not supplier_bin or not buyer_bin:
        # fallback ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–∑—è—Ç—å –ø–µ—Ä–≤—ã–µ –¥–≤–∞ –ë–ò–ù–∞ –ø–æ–¥—Ä—è–¥
        all_bins = re.findall(r"–ë–ò–ù[^\d]{0,5}([0-9]{11,12})", text, re.IGNORECASE)
        if len(all_bins) >= 1 and not supplier_bin:
            supplier_bin = all_bins[0]
        if len(all_bins) >= 2 and not buyer_bin:
            buyer_bin = all_bins[1]

    # ------------------------------------------------------------
    # üìÖ –î–∞—Ç–∞ ‚Äî –ª—é–±—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (DD.MM.YYYY, YYYY-MM-DD, ‚Äú–æ—Ç ‚Ä¶‚Äù)
    # ------------------------------------------------------------
    date_issue = ""
    DATE_PATTERNS = [
        r"–î–∞—Ç–∞\s*(?:–≤—ã–ø–∏—Å–∫–∏|–≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è|—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è)?\s*[:\-‚Äì]?\s*([0-9]{1,2}\s*[./-]\s*[0-9]{1,2}\s*[./-]\s*[0-9]{2,4})",
        r"–î–∞—Ç–∞\s*(?:–≤—ã–ø–∏—Å–∫–∏|–≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è)?\s*[:\-‚Äì]?\s*([0-9]{4}\s*[./-]\s*[0-9]{1,2}\s*[./-]\s*[0-9]{1,2})",
        r"–æ—Ç\s*([0-9]{4}\s*[./-]\s*[0-9]{1,2}\s*[./-]\s*[0-9]{1,2})",
        r"–æ—Ç\s*([0-9]{1,2}\s*[./-]\s*[0-9]{1,2}\s*[./-]\s*[0-9]{2,4})",
        r"–í—ã–ø–∏—Å–∞–Ω[^\d]{0,5}([0-9]{1,2}[./-][0-9]{1,2}[./-][0-9]{2,4})",
    ]
    for pat in DATE_PATTERNS:
        m = re.search(pat, text, re.IGNORECASE)
        if m:
            date_issue = m.group(1)
            date_issue = re.sub(r"\s*[./-]\s*", ".", date_issue)
            break

    # ------------------------------------------------------------
    # üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ ‚Äî ‚Äú–í—Å–µ–≥–æ —Å –ù–î–°‚Äù, ‚Äú–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ‚Äù, fallback
    # ------------------------------------------------------------
    total_amount = ""
    SUM_PATTERNS = [
        # –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ ‚Äî —Å –ù–î–°
        r"(?:–í—Å–µ–≥–æ\s*—Å\s*–ù–î–°|–ò—Ç–æ–≥–æ\s*—Å\s*–ù–î–°)\s*[:\-‚Äì]?\s*([\d\s.,]+)(?:\s*[A-Z–ê-–Øa-z–∞-—è‚Ç∏]{0,5})?",
        # –≤–∞—Ä–∏–∞–Ω—Ç ERP ‚Äî ‚Äú–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ‚Äù
        r"(?:–ò—Ç–æ–≥–æ\s*–∫\s*–æ–ø–ª–∞—Ç–µ)\s*[:\-‚Äì]?\s*([\d\s.,]+)(?:\s*[A-Z–ê-–Øa-z–∞-—è‚Ç∏]{0,5})?",
        # –≤–∞—Ä–∏–∞–Ω—Ç ‚Äú–û–±—â–∞—è —Å—É–º–º–∞‚Äù
        r"(?:–û–±—â–∞—è\s*—Å—É–º–º–∞)\s*[:\-‚Äì]?\s*([\d\s.,]+)",
        # fallback ‚Äî –ø–æ—Å–ª–µ–¥–Ω—è—è ‚Äú–í—Å–µ–≥–æ‚Äù –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
        r"–í—Å–µ–≥–æ\s*[:\-‚Äì]?\s*([\d\s.,]+)(?:\s*[A-Z–ê-–Øa-z–∞-—è‚Ç∏]{0,5})?$",
    ]
    matches = []
    for pat in SUM_PATTERNS:
        matches += re.findall(pat, text, re.IGNORECASE)

    if matches:
        # –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ (–∏—Ç–æ–≥)
        total_amount = matches[-1]
        total_amount = (
            total_amount.replace(" ", "")
            .replace("\u00A0", "")
            .replace(",", ".")
            .strip()
        )

    # ------------------------------------------------------------
    # üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç
    # ------------------------------------------------------------
    return {
        "supplier_BIN": supplier_bin,
        "recipient_BIN": buyer_bin,
        "date_issue": date_issue,
        "total_amount": total_amount,
        "raw_text": text,
    }

# ------------------------------------------------------------
# üß™ –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
# ------------------------------------------------------------
def debug_extract_bins(path: str):
    data = parse_pdf_content(path)
    print("=== –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ PDF ===")
    print(f"supplier_BIN: {data.get('supplier_BIN')}")
    print(f"recipient_BIN: {data.get('recipient_BIN')}")
    print(f"date_issue: {data.get('date_issue')}")
    print(f"total_amount: {data.get('total_amount')}")
    print("------ –§—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞ ------")
    print(data.get('raw_text', '')[:800])
    print("------------------------------")

# ------------------------------------------------------------
# CLI-–∑–∞–ø—É—Å–∫
# ------------------------------------------------------------
if __name__ == "__main__":
    import sys
    if len(sys.argv) < 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python pdf_reader.py <–ø—É—Ç—å_–∫_PDF>")
    else:
        debug_extract_bins(sys.argv[1])
