# ============================================================
# summary_engine.py ‚Äî ULYULYU CHECKER v1.0 (Human Summary Engine)
# 2025-11-10: reason: –¥–æ–±–∞–≤–ª–µ–Ω –º–æ–¥—É–ª—å —Å–≤–æ–¥–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
#                     –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ ValidationResult –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç
#                     –∫–æ—Ä–æ—Ç–∫–æ–µ "—á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ" —Ä–µ–∑—é–º–µ –æ —Å—Ç–∞—Ç—É—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞.
# ============================================================

from typing import List, Dict, Any
from core.validator import ValidationResult

# ------------------------------------------------------------
# üß© –õ–µ–π–±–ª—ã ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ / –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
# ------------------------------------------------------------
_LABELS: Dict[str, str] = {
    "BIN001": "–Ω–µ –Ω–∞–π–¥–µ–Ω –ë–ò–ù –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞",
    "BIN002": "–Ω–µ –Ω–∞–π–¥–µ–Ω –ë–ò–ù –ø–æ–∫—É–ø–∞—Ç–µ–ª—è",
    "BIN007": "–ë–ò–ù—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è —Å–æ–≤–ø–∞–¥–∞—é—Ç",
    "BIN012": "–æ—à–∏–±–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã –ë–ò–ù",
    "D000": "–Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞",
    "D001": "–¥–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º",
    "TOT001": "–æ—à–∏–±–∫–∞ –≤ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º–µ",
    "NEG001": "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—É–º–º"
}

# –ö–ª—é—á–µ–≤—ã–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–≤–æ–¥–æ–∫ (–±—É–¥–µ—Ç —Ä–∞—Å—à–∏—Ä—è—Ç—å—Å—è)
_GROUP_TITLES = {
    "BIN": "—Ä–µ–∫–≤–∏–∑–∏—Ç–∞—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ (–ë–ò–ù)",
    "DATE": "–¥–∞—Ç–∞—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞",
    "SUM": "—Å—É–º–º–∞—Ö –∏ –∏—Ç–æ–≥–∞—Ö"
}

# ------------------------------------------------------------
# üß† –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
# ------------------------------------------------------------
def summarize_results(results: List[ValidationResult]) -> Dict[str, Any]:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫—Ä–∞—Ç–∫–æ–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        {
          "status": "ok" | "warn" | "error",
          "title": "–í—Å—ë —Ö–æ—Ä–æ—à–æ / –ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è / –û—à–∏–±–∫–∏",
          "message": "–ß–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ",
          "affected": ["BIN001", "D000"]
        }
    """
    if not results:
        return {
            "status": "ok",
            "title": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
            "message": "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.",
            "affected": []
        }

    # --- –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–Ω–∏
    errors = [r for r in results if r.level.upper() in ("ERROR", "ERR")]
    warns  = [r for r in results if r.level.upper() in ("WARN", "WARNING")]
    oks    = [r for r in results if r.level.upper() == "OK"]

    codes_error = [r.code for r in errors]
    codes_warn  = [r.code for r in warns]

    # --- –°–≤–æ–¥–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    if errors:
        status = "error"
        title = "–ï—Å—Ç—å –æ—à–∏–±–∫–∏"
    elif warns:
        status = "warn"
        title = "–ï—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è"
    else:
        status = "ok"
        title = "–î–æ–∫—É–º–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"

    # --- –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    message_parts: List[str] = []

    # 1. –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç –≤–æ–æ–±—â–µ
    if not errors and not warns:
        message = "–î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω. –û—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ."
        return {"status": status, "title": title, "message": message, "affected": []}

    # 2. –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è
    for code in codes_error + codes_warn:
        label = _LABELS.get(code)
        if label and label not in message_parts:
            message_parts.append(label)

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º —á–∏—Ç–∞–µ–º—É—é —Ñ—Ä–∞–∑—É
    if not message_parts:
        message = "–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏ –∏–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞."
    elif len(message_parts) == 1:
        message = f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: {message_parts[0]}."
    elif len(message_parts) == 2:
        message = f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: {message_parts[0]} –∏ {message_parts[1]}."
    elif len(message_parts) <= 4:
        message = "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã: " + ", ".join(message_parts[:-1]) + f" –∏ {message_parts[-1]}."
    else:
        # —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
        message = "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—è—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞."

    # 4. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
    if "BIN001" in codes_error and "BIN002" in codes_error:
        message = "–ù–µ —É–∫–∞–∑–∞–Ω—ã –ë–ò–ù—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è."
    elif "BIN007" in codes_warn and not errors:
        message = "–ë–ò–ù—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤."
    elif "D000" in codes_error and not errors:
        message = "–ù–µ —É–∫–∞–∑–∞–Ω–∞ –¥–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–Ω—è—Ç."
    elif "D001" in codes_error:
        message = "–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —É–∫–∞–∑–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞—Ç—ã."
    elif "BIN012" in codes_warn and not errors:
        message = "–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –ë–ò–ù –Ω–µ –ø—Ä–æ—à–ª–∞ ‚Äî –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞."

    return {
        "status": status,
        "title": title,
        "message": message,
        "affected": list(set(codes_error + codes_warn))
    }

# ------------------------------------------------------------
# üß™ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
# ------------------------------------------------------------
if __name__ == "__main__":
    demo = [
        ValidationResult(code="BIN007", level="WARN", message="–ë–ò–ù—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç"),
        ValidationResult(code="D001", level="ERROR", message="–î–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º"),
        ValidationResult(code="BIN012", level="OK", message="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –ë–ò–ù: –û–ö"),
    ]
    res = summarize_results(demo)
    print(f"[{res['status'].upper()}] {res['title']}: {res['message']}")
    print("‚Äî –ó–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª–∞:", ", ".join(res["affected"]))
